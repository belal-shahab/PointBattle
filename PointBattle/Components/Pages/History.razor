@page "/history"
@using PointBattle.Models
@using PointBattle.Services
@inject DatabaseService DbService
@inject NavigationManager Navigation

<div class="history-container">
    <h2>Game History</h2>

    @if (games.Count == 0)
    {
        <p>No games played yet!</p>
    }
    else
    {
        <div class="games-list">
            @foreach (var game in games)
            {
                <div class="game-card">
                    <div class="game-card-content" @onclick="() => ViewGame(game.Id)">
                        <div class="game-date">@game.Date.ToString("MMM d, yyyy")</div>
                        <div class="game-teams">@game.GroupA vs @game.GroupB</div>
                        <div class="game-score">@game.GroupATotal - @game.GroupBTotal</div>
                        <div class="game-winner">
                            @if (game.GroupATotal > game.GroupBTotal)
                            {
                                <span>@game.GroupA wins!</span>
                            }
                            else if (game.GroupBTotal > game.GroupATotal)
                            {
                                <span>@game.GroupB wins!</span>
                            }
                            else
                            {
                                <span>Tie game</span>
                            }
                        </div>
                    </div>
                    <div class="game-card-actions">
                        <button class="delete-button" @onclick="() => DeleteGame(game.Id)">Delete</button>
                    </div>
                </div>
            }
        </div>
    }

    <!--@if (showDeleteConfirm)
        {
            <div class="modal-overlay">
                <div class="modal">
                    <h3>Confirm Delete</h3>
                    <p>Are you sure you want to delete this game?</p>
                    <div class="modal-actions">
                        <button class="btn secondary" @onclick="CancelDelete">Cancel</button>
                        <button class="btn danger" @onclick="ConfirmDelete">Delete</button>
                    </div>
                </div>
            </div>
        }-->

    <div class="button-container">
        <button class="btn secondary" @onclick="BackToHome">Back</button>
    </div>
</div>

@code {
    private List<Game> games = new List<Game>();
    private bool showDeleteConfirm = false;
    private int gameIdToDelete = 0;

    protected override async Task OnInitializedAsync()
    {
        await LoadGames();
    }

    private async Task LoadGames()
    {
        games = await DbService.GetGamesAsync();
    }

    private void ViewGame(int id)
    {
        Navigation.NavigateTo($"/gameresult/{id}");
    }

    private void DeleteGame(int id)
    {
        gameIdToDelete = id;
        showDeleteConfirm = true;
        ConfirmDelete();
    }

    private void CancelDelete()
    {
        gameIdToDelete = 0;
        showDeleteConfirm = false;
    }

    private async Task ConfirmDelete()
    {
        if (gameIdToDelete > 0)
        {
            await DbService.DeleteGameAsync(gameIdToDelete);
            await LoadGames();
            showDeleteConfirm = false;
        }
    }

    private void BackToHome()
    {
        Navigation.NavigateTo("/");
    }

}